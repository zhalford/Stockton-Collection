<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>John Stockton Flawless Ruby Collection Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #2d1b4e, #0f2027);
            color: #fff;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .auth-section {
            background: linear-gradient(135deg, rgba(93, 46, 145, 0.3), rgba(249, 166, 2, 0.2));
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            border: 1px solid rgba(249, 166, 2, 0.3);
        }

        .auth-section.hidden {
            display: none;
        }

        .auth-button {
            background: linear-gradient(135deg, #5d2e91, #f9a602);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin: 10px;
            transition: transform 0.2s ease;
        }

        .auth-button:hover {
            transform: translateY(-2px);
        }

        .user-info {
            background: linear-gradient(135deg, rgba(93, 46, 145, 0.2), rgba(0, 71, 27, 0.1));
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(249, 166, 2, 0.3);
        }

        .user-info.hidden {
            display: none;
        }

        .share-section {
            background: linear-gradient(135deg, rgba(0, 71, 27, 0.2), rgba(249, 166, 2, 0.1));
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid rgba(0, 71, 27, 0.3);
        }

        .share-section.hidden {
            display: none;
        }

        .share-link {
            background: rgba(93, 46, 145, 0.2);
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
            margin: 10px 0;
            font-family: monospace;
        }

        .public-notice {
            background: linear-gradient(135deg, rgba(0, 71, 27, 0.3), rgba(249, 166, 2, 0.2));
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid rgba(0, 71, 27, 0.5);
        }

        .public-notice.hidden {
            display: none;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #5d2e91, #f9a602, #00471b);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(93, 46, 145, 0.3), rgba(249, 166, 2, 0.2));
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(249, 166, 2, 0.3);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(93, 46, 145, 0.3);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            border: 1px solid rgba(249, 166, 2, 0.4);
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: linear-gradient(135deg, #5d2e91, #f9a602);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(93, 46, 145, 0.4);
        }

        .year-section {
            margin-bottom: 40px;
            background: linear-gradient(135deg, rgba(93, 46, 145, 0.1), rgba(0, 71, 27, 0.1));
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(249, 166, 2, 0.2);
        }

        .year-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #f9a602;
            border-bottom: 2px solid #f9a602;
            padding-bottom: 10px;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .card-item {
            background: linear-gradient(135deg, rgba(93, 46, 145, 0.2), rgba(0, 71, 27, 0.1));
            border-radius: 12px;
            padding: 20px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .card-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(93, 46, 145, 0.3);
            border-color: rgba(249, 166, 2, 0.5);
        }

        .card-item.owned {
            border-color: #00471b;
            background: linear-gradient(135deg, rgba(0, 71, 27, 0.3), rgba(93, 46, 145, 0.1));
            box-shadow: 0 0 20px rgba(0, 71, 27, 0.3);
        }

        .card-item.wanted {
            border-color: #f9a602;
            background: linear-gradient(135deg, rgba(249, 166, 2, 0.3), rgba(93, 46, 145, 0.1));
            box-shadow: 0 0 20px rgba(249, 166, 2, 0.3);
        }

        .card-image {
            width: 100%;
            height: 400px;
            background: linear-gradient(45deg, #333, #555);
            border-radius: 8px;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
        }

        .card-image img {
            max-width: 90%;
            max-height: 90%;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .card-image.has-image {
            border: 2px solid rgba(249, 166, 2, 0.7);
            background: #fff;
            padding: 10px;
        }

        .card-image:hover {
            border-color: #f9a602;
        }

        .card-info h3 {
            font-size: 1.2rem;
            margin-bottom: 8px;
            color: #fff;
        }

        .card-details {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 15px;
        }

        .card-number {
            background: linear-gradient(135deg, rgba(93, 46, 145, 0.4), rgba(249, 166, 2, 0.3));
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            display: inline-block;
            margin-bottom: 10px;
            border: 1px solid rgba(249, 166, 2, 0.4);
        }

        .status-controls {
            display: flex;
            gap: 10px;
        }

        .status-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .status-btn.owned {
            background: linear-gradient(135deg, #00471b, #228B22);
            color: white;
        }

        .status-btn.wanted {
            background: linear-gradient(135deg, #f9a602, #FFD700);
            color: #000;
            font-weight: 600;
        }

        .status-btn.none {
            background: rgba(93, 46, 145, 0.3);
            color: white;
            border: 1px solid rgba(249, 166, 2, 0.3);
        }

        .status-btn:hover {
            opacity: 0.8;
            transform: scale(0.98);
        }

        .status-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .hidden {
            display: none;
        }

        .image-upload {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.2rem;
            color: #f9a602;
        }

        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(93, 46, 145, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 0.9rem;
            z-index: 1000;
            border: 1px solid rgba(249, 166, 2, 0.5);
        }

        .sync-status.synced {
            background: rgba(0, 71, 27, 0.9);
        }

        .sync-status.error {
            background: rgba(139, 0, 0, 0.9);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }

            .user-info {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Authentication Section -->
        <div id="authSection" class="auth-section">
            <h2>🏀 Welcome to Your Stockton Collection</h2>
            <p>Sign in to save your collection progress and images permanently</p>
            <button id="signInBtn" class="auth-button">Sign in with Google</button>
        </div>

        <!-- Public Notice -->
        <div id="publicNotice" class="public-notice hidden">
            <h3>📖 Public Collection View</h3>
            <p>You're viewing a read-only collection. Sign in to create your own tracker!</p>
        </div>

        <!-- User Info Section -->
        <div id="userInfo" class="user-info hidden">
            <div>
                <span>👋 Welcome, <span id="userName"></span></span>
                <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 5px;">
                    <span id="syncStatus">All data synced to cloud</span>
                </div>
            </div>
            <button id="signOutBtn" class="auth-button">Sign Out</button>
        </div>

        <!-- Share Section -->
        <div id="shareSection" class="share-section hidden">
            <h3>📤 Share Your Collection</h3>
            <p>Anyone with this link can view your collection (read-only):</p>
            <div class="share-link" id="shareLink">Loading share link...</div>
            <button class="auth-button" onclick="copyShareLink()">📋 Copy Link</button>
        </div>

        <div class="header">
            <h1>🏀 John Stockton Flawless Ruby Collection</h1>
            <p>Complete Checklist (2012-2024) • Limited to 15 copies each</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalCards">59</div>
                <div>Total Cards</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="ownedCount">0</div>
                <div>Cards Owned</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="wantedCount">0</div>
                <div>Acquisition Targets</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completionRate">0%</div>
                <div>Collection Complete</div>
            </div>
        </div>

        <div class="controls">
            <button class="filter-btn active" onclick="filterCards('all')">All Cards</button>
            <button class="filter-btn" onclick="filterCards('owned')">Owned</button>
            <button class="filter-btn" onclick="filterCards('wanted')">Wanted</button>
            <button class="filter-btn" onclick="filterCards('none')">Need Status</button>
        </div>

        <div id="collection">
            <div class="loading">Loading collection...</div>
        </div>
    </div>

    <!-- Sync Status Indicator -->
    <div id="syncIndicator" class="sync-status hidden">
        Syncing...
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules - CHANGED TO REALTIME DATABASE
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, set, get, update, push } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAniNGhjcBl0ktM4Mkxkz_Humv9t8Hnc_k",
            authDomain: "ruby-collection.firebaseapp.com",
            databaseURL: "https://ruby-collection-default-rtdb.firebaseio.com",
            projectId: "ruby-collection",
            storageBucket: "ruby-collection.firebasestorage.app",
            messagingSenderId: "508190984",
            appId: "1:508190984:web:1b91640b7b5fc0bda7ccbd"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app); // CHANGED FROM getFirestore
        const storage = getStorage(app);

        // Global variables
        let currentUser = null;
        let cardStatuses = {};
        let cardImages = {};
        let isPublicView = false;
        let ownerUserId = null; // For public view

        const cardData = [
            // 2012-13 Panini Flawless Basketball (4 cards)
            { year: '2012-13', name: 'Patches Ruby', number: '#62', type: 'Memorabilia (Patch)', print: '/15' },
            { year: '2012-13', name: 'Greats Autographs Ruby', number: '#35', type: 'Autograph', print: '/15' },
            { year: '2012-13', name: 'Greats Patches Autographs Ruby', number: '#18', type: 'Autograph + Patch', print: '/15' },
            { year: '2012-13', name: 'Great Dual Patches Auto Ruby', number: '#11', type: 'Autograph + Dual Patch', print: '/15' },
            
            // 2013-14 Panini Flawless Basketball (6 cards)
            { year: '2013-14', name: 'Ruby', number: '#80', type: 'Base card', print: '/15' },
            { year: '2013-14', name: 'Patches Ruby', number: '#72', type: 'Memorabilia (Patch)', print: '/15' },
            { year: '2013-14', name: 'Greats Dual Memorabilia Autographs Ruby', number: '#GR-JS', type: 'Autograph + Dual Memorabilia', print: '/15' },
            { year: '2013-14', name: 'Hall of Fame Autographs Memorabilia Ruby', number: 'TBD', type: 'Autograph + Memorabilia', print: '/15' },
            { year: '2013-14', name: 'Retired Numbers Autographs Ruby', number: '#RN-JS', type: 'Autograph', print: '/15' },
            
            // 2014-15 Panini Flawless Basketball (9 cards)
            { year: '2014-15', name: 'Ruby Gem', number: '#80', type: 'Base card (Gem)', print: '/15' },
            { year: '2014-15', name: 'Ruby Gem', number: '#164', type: 'Base card (Gem)', print: '/15' },
            { year: '2014-15', name: 'Patch Autographs Ruby', number: '#PA-JS', type: 'Autograph + Patch', print: '/15' },
            { year: '2014-15', name: 'Hall of Fame Autographs Ruby', number: '#HOF-JS', type: 'Autograph', print: '/15' },
            { year: '2014-15', name: 'Association Autographs Ruby', number: '#AA-JS', type: 'Autograph', print: '/15' },
            { year: '2014-15', name: 'Flawless Finishes Auto Ruby', number: '#FF-JS', type: 'Autograph', print: '/15' },
            { year: '2014-15', name: 'Greats Dual Memorabilia Auto Ruby', number: '#GDM-JS', type: 'Autograph + Dual Memorabilia', print: '/15' },
            { year: '2014-15', name: 'Momentous Auto Ruby', number: '#MA-JS', type: 'Autograph', print: '/15' },
            { year: '2014-15', name: 'Super Signatures Ruby', number: '#JSSS', type: 'Autograph', print: '/15' },
            
            // 2015-16 Panini Flawless Basketball (7 cards)
            { year: '2015-16', name: 'Ruby Gem', number: '#133', type: 'Base card (Gem)', print: '/15' },
            { year: '2015-16', name: 'Flawless Autographs Ruby', number: '#FA-JS', type: 'Autograph', print: '/15' },
            { year: '2015-16', name: 'Premium Ink Ruby', number: '#PI-JS', type: 'Autograph', print: '/15' },
            { year: '2015-16', name: 'Dual Patch Autographs Ruby', number: '#DPA-JST', type: 'Autograph + 2× Patch', print: '/15' },
            { year: '2015-16', name: 'Star Swatch Signatures Ruby', number: '#SR-JS', type: 'Autograph + Memorabilia', print: '/15' },
            { year: '2015-16', name: 'Super Signatures Ruby', number: '#SS-JS', type: 'Autograph', print: '/15' },
            { year: '2015-16', name: 'Greats Dual Memorabilia Auto Ruby', number: '#GR-JS', type: 'Autograph + Dual Memorabilia', print: '/15' },
            
            // 2016-17 Panini Flawless Basketball (5 cards)
            { year: '2016-17', name: 'Greats Autographs Ruby', number: '#G-JS', type: 'Autograph', print: '/15' },
            { year: '2016-17', name: 'Premium Ink Ruby', number: '#PI-JS', type: 'Autograph', print: '/15' },
            { year: '2016-17', name: 'Premium Ink Ruby Gold Proof', number: '#PI-JS', type: 'Autograph', print: '/2' },
            { year: '2016-17', name: 'Flawless Autographs Ruby', number: '#FA-JS', type: 'Autograph', print: '/15' },
            { year: '2016-17', name: 'Flawless Autographs Ruby Gold Proof', number: '#FA-JS', type: 'Autograph', print: '/2' },
            
            // 2017-18 Panini Flawless Basketball (6 cards)
            { year: '2017-18', name: 'Excellence Signatures Ruby', number: '#ES-JST', type: 'Autograph', print: '/15' },
            { year: '2017-18', name: 'Distinguished Autographs Ruby', number: '#DA-JS', type: 'Autograph', print: '/15' },
            { year: '2017-18', name: 'Enshrined Signatures Ruby', number: '#ES-JS', type: 'Autograph', print: '/15' },
            { year: '2017-18', name: 'Patches Ruby', number: '#P-JS', type: 'Memorabilia (Patch)', print: '/15' },
            { year: '2017-18', name: 'Momentous Autographs Ruby', number: '#MA-JST', type: 'Autograph', print: '/15' },
            { year: '2017-18', name: 'Honored Numbers Ruby Auto', number: '#HN-JS', type: 'Autograph', print: '/15' },
            
            // 2018-19 Panini Flawless Basketball (4 cards)
            { year: '2018-19', name: 'Legendary Scripts Ruby', number: '#LS-JSK', type: 'Autograph', print: '/15' },
            { year: '2018-19', name: 'Enshrined Signatures Ruby', number: '#ES-JSK', type: 'Autograph', print: '/15' },
            { year: '2018-19', name: 'Patch Autographs Ruby', number: '#PA-JSK', type: 'Autograph + Patch', print: '/15' },
            { year: '2018-19', name: 'Patches Ruby', number: '#P-JSK', type: 'Memorabilia (Patch)', print: '/15' },
            
            // 2019-20 Panini Flawless Basketball (2 cards)
            { year: '2019-20', name: 'Enshrined Signatures Ruby', number: '#ES-JSK', type: 'Autograph', print: '/15' },
            { year: '2019-20', name: 'Flawless Finishes Ruby', number: '#FF-JSK', type: 'Autograph', print: '/15' },
            
            // 2020-21 Panini Flawless Basketball (4 cards)
            { year: '2020-21', name: 'Distinguished Autographs Ruby', number: '#DIS-STO', type: 'Autograph', print: '/15' },
            { year: '2020-21', name: 'Flawless Finishes Ruby', number: '#FIN-STO', type: 'Autograph', print: '/15' },
            { year: '2020-21', name: 'Enshrined Signatures Ruby', number: '#ENS-STO', type: 'Autograph', print: '/15' },
            { year: '2020-21', name: 'Legendary Scripts Ruby', number: '#LEG-STO', type: 'Autograph', print: '/15' },
            
            // 2021-22 Panini Flawless Basketball (4 cards)
            { year: '2021-22', name: 'Enshrined Signatures Ruby', number: '#ENS-JST', type: 'Autograph', print: '/15' },
            { year: '2021-22', name: '75th Team Autographs Ruby', number: '#75A-JST', type: 'Autograph', print: '/15' },
            { year: '2021-22', name: 'Legendary Scripts Ruby', number: '#LSC-JST', type: 'Autograph', print: '/15' },
            { year: '2021-22', name: 'USA Basketball Ruby', number: '#USA-JST', type: 'Autograph', print: '/15' },
            
            // 2022-23 Panini Flawless Basketball (4 cards)
            { year: '2022-23', name: 'Distinguished Autographs Ruby', number: '#DA-JST', type: 'Autograph', print: '/15' },
            { year: '2022-23', name: 'Flawless Autographs Ruby', number: '#FA-JST', type: 'Autograph', print: '/15' },
            { year: '2022-23', name: 'Momentous Autographs Ruby', number: '#MA-JST', type: 'Autograph', print: '/15' },
            { year: '2022-23', name: 'USA Basketball Ruby Auto', number: '#USA-JST', type: 'Autograph', print: '/15' },
            
            // 2023-24 Panini Flawless Basketball (4 cards)
            { year: '2023-24', name: 'Draft Gem Signatures Ruby', number: '#5', type: 'Autograph', print: '/15' },
            { year: '2023-24', name: 'Flawless Achievements Ruby', number: '#FA-JSK', type: 'Autograph', print: '/15' },
            { year: '2023-24', name: 'Flawless Loyal Greats Ruby', number: '#FLG-JST', type: 'Autograph', print: '/15' },
            { year: '2023-24', name: 'Flawless Penmanship Ruby', number: '#FPS-JSK', type: 'Autograph', print: '/15' }
        ];

        // DOM Elements
        const authSection = document.getElementById('authSection');
        const userInfo = document.getElementById('userInfo');
        const publicNotice = document.getElementById('publicNotice');
        const shareSection = document.getElementById('shareSection');
        const signInBtn = document.getElementById('signInBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const userName = document.getElementById('userName');
        const syncStatus = document.getElementById('syncStatus');
        const syncIndicator = document.getElementById('syncIndicator');
        const shareLink = document.getElementById('shareLink');
        const collection = document.getElementById('collection');

        // Check for URL parameters for public viewing
        function checkForPublicView() {
            const urlParams = new URLSearchParams(window.location.search);
            const publicUserId = urlParams.get('user');
            
            if (publicUserId) {
                isPublicView = true;
                ownerUserId = publicUserId;
                console.log('Public view detected for user:', publicUserId);
                return true;
            }
            return false;
        }

        // Authentication functions
        signInBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('Sign in error:', error);
                alert('Sign in failed. Please try again.');
            }
        });

        signOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Sign out error:', error);
            }
        });

        // Auth state observer
        onAuthStateChanged(auth, async (user) => {
            console.log('Auth state changed:', user ? 'signed in' : 'signed out');
            
            if (user) {
                currentUser = user;
                isPublicView = false; // Override public view if user signs in
                authSection.classList.add('hidden');
                userInfo.classList.remove('hidden');
                shareSection.classList.remove('hidden');
                publicNotice.classList.add('hidden');
                userName.textContent = user.displayName || user.email;
                
                // Update share link
                const baseUrl = window.location.origin + window.location.pathname;
                shareLink.textContent = `${baseUrl}?user=${user.uid}`;
                
                // Load user data
                await loadUserData();
                initializeCollection();
            } else {
                currentUser = null;
                
                // Check if this is a public view
                if (checkForPublicView()) {
                    console.log('Loading public collection for user:', ownerUserId);
                    authSection.classList.remove('hidden');
                    userInfo.classList.add('hidden');
                    shareSection.classList.add('hidden');
                    publicNotice.classList.remove('hidden');
                    
                    // Load public data
                    await loadPublicData();
                    initializeCollection();
                } else {
                    authSection.classList.remove('hidden');
                    userInfo.classList.add('hidden');
                    shareSection.classList.add('hidden');
                    publicNotice.classList.add('hidden');
                    collection.innerHTML = '<div class="loading">Please sign in to access your collection...</div>';
                }
            }
        });

        // Firebase data functions - UPDATED FOR REALTIME DATABASE
        async function loadUserData() {
            if (!currentUser) return;
            
            console.log('Loading user data for:', currentUser.uid);
            showSyncIndicator('Loading...');
            try {
                // Load from private user data
                const userRef = ref(database, `users/${currentUser.uid}`);
                const snapshot = await get(userRef);
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    cardStatuses = data.cardStatuses || {};
                    cardImages = data.cardImages || {};
                    console.log('Loaded user data:', { cardStatuses, cardImages });
                } else {
                    console.log('No existing user data found');
                    cardStatuses = {};
                    cardImages = {};
                }
                
                hideSyncIndicator();
                updateStats();
            } catch (error) {
                console.error('Error loading user data:', error);
                showSyncIndicator('Error loading data', 'error');
            }
        }

        async function loadPublicData() {
            if (!ownerUserId) return;
            
            console.log('Loading public data for:', ownerUserId);
            showSyncIndicator('Loading public collection...');
            try {
                // Load from public collections
                const publicRef = ref(database, `publicCollections/${ownerUserId}`);
                const snapshot = await get(publicRef);
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    cardStatuses = data.cardStatuses || {};
                    cardImages = data.cardImages || {};
                    console.log('Loaded public data:', { cardStatuses, cardImages });
                } else {
                    console.log('No public collection found for user:', ownerUserId);
                    cardStatuses = {};
                    cardImages = {};
                }
                
                hideSyncIndicator();
                updateStats();
            } catch (error) {
                console.error('Error loading public data:', error);
                showSyncIndicator('Error loading public collection', 'error');
                setTimeout(() => {
                    collection.innerHTML = '<div class="loading">Unable to load public collection. Please try again later.</div>';
                }, 2000);
            }
        }

        async function saveUserData() {
            if (!currentUser) return;
            
            console.log('Saving user data...');
            showSyncIndicator('Syncing...');
            try {
                const userData = {
                    cardStatuses: cardStatuses,
                    cardImages: cardImages,
                    lastUpdated: new Date().toISOString()
                };

                // Save to private user data
                await set(ref(database, `users/${currentUser.uid}`), userData);
                
                // Also save to public collection for sharing
                await set(ref(database, `publicCollections/${currentUser.uid}`), userData);
                
                console.log('Data saved successfully');
                showSyncIndicator('Synced', 'synced');
                setTimeout(hideSyncIndicator, 2000);
            } catch (error) {
                console.error('Error saving user data:', error);
                showSyncIndicator('Sync error', 'error');
            }
        }

        async function uploadImage(file, cardId) {
            if (!currentUser) return null;
            
            console.log('Uploading image for card:', cardId);
            showSyncIndicator('Uploading image...');
            try {
                // Upload to both private and public storage
                const privateImageRef = storageRef(storage, `images/${currentUser.uid}/${cardId}`);
                const publicImageRef = storageRef(storage, `publicImages/${currentUser.uid}/${cardId}`);
                
                // Upload to both locations
                await uploadBytes(privateImageRef, file);
                await uploadBytes(publicImageRef, file);
                
                // Get public URL for sharing
                const downloadURL = await getDownloadURL(publicImageRef);
                
                cardImages[cardId] = downloadURL;
                await saveUserData();
                
                console.log('Image uploaded successfully:', downloadURL);
                return downloadURL;
            } catch (error) {
                console.error('Error uploading image:', error);
                showSyncIndicator('Upload error', 'error');
                return null;
            }
        }

        // UI Helper functions
        function showSyncIndicator(message, type = '') {
            syncIndicator.textContent = message;
            syncIndicator.className = `sync-status ${type}`;
            syncIndicator.classList.remove('hidden');
        }

        function hideSyncIndicator() {
            syncIndicator.classList.add('hidden');
        }

        // Share functionality
        window.copyShareLink = function() {
            const linkText = shareLink.textContent;
            navigator.clipboard.writeText(linkText).then(() => {
                alert('Share link copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = linkText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Share link copied to clipboard!');
            });
        };

        // Collection functions
        function initializeCollection() {
            console.log('Initializing collection...');
            const yearGroups = {};
            
            // Group cards by year
            cardData.forEach((card, index) => {
                card.id = index;
                if (!yearGroups[card.year]) {
                    yearGroups[card.year] = [];
                }
                yearGroups[card.year].push(card);
            });

            // Create HTML for each year
            let html = '';
            Object.keys(yearGroups).sort().forEach(year => {
                html += `
                    <div class="year-section">
                        <h2 class="year-title">${year} Panini Flawless Basketball (${yearGroups[year].length} cards)</h2>
                        <div class="cards-grid">
                `;
                
                yearGroups[year].forEach(card => {
                    html += createCardHTML(card);
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            collection.innerHTML = html;
            updateStats();
            console.log('Collection initialized');
        }

        function createCardHTML(card) {
            const status = cardStatuses[card.id] || 'none';
            const imageUrl = cardImages[card.id];
            const isEditable = !isPublicView && currentUser; // Only editable if signed in and not public view
            
            return `
                <div class="card-item ${status}" data-status="${status}" data-id="${card.id}">
                    <div class="card-image ${imageUrl ? 'has-image' : ''}" ${isEditable ? `onclick="triggerImageUpload(${card.id})"` : ''}>
                        <div id="image-${card.id}">
                            ${imageUrl ? `<img src="${imageUrl}" alt="Card Image">` : (isEditable ? 'Click to add card image' : 'No image available')}
                        </div>
                        ${isEditable ? `<input type="file" class="image-upload" id="upload-${card.id}" accept="image/*" onchange="handleImageUpload(event, ${card.id})">` : ''}
                    </div>
                    <div class="card-info">
                        <div class="card-number">${card.number} ${card.print}</div>
                        <h3>${card.name}</h3>
                        <div class="card-details">${card.type}</div>
                        <div class="status-controls">
                            <button class="status-btn ${status === 'owned' ? 'owned' : 'none'}" 
                                    ${isEditable ? `onclick="setStatus(${card.id}, 'owned')"` : 'disabled'}>
                                ✓ Owned
                            </button>
                            <button class="status-btn ${status === 'wanted' ? 'wanted' : 'none'}" 
                                    ${isEditable ? `onclick="setStatus(${card.id}, 'wanted')"` : 'disabled'}>
                                ⭐ Want
                            </button>
                            <button class="status-btn ${status === 'none' ? 'none' : 'none'}" 
                                    ${isEditable ? `onclick="setStatus(${card.id}, 'none')"` : 'disabled'}>
                                Clear
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Global functions (needed for onclick handlers)
        window.triggerImageUpload = function(cardId) {
            if (!currentUser || isPublicView) {
                alert('Please sign in to upload images');
                return;
            }
            document.getElementById(`upload-${cardId}`).click();
        };

        window.handleImageUpload = async function(event, cardId) {
            const file = event.target.files[0];
            if (file && currentUser && !isPublicView) {
                const imageUrl = await uploadImage(file, cardId);
                if (imageUrl) {
                    const imageContainer = document.getElementById(`image-${cardId}`);
                    const cardImageDiv = imageContainer.parentElement;
                    
                    imageContainer.innerHTML = `<img src="${imageUrl}" alt="Card Image">`;
                    cardImageDiv.classList.add('has-image');
                }
            }
        };

        window.setStatus = async function(cardId, status) {
            if (!currentUser || isPublicView) {
                alert('Please sign in to update card status');
                return;
            }

            const currentStatus = cardStatuses[cardId];
            
            if (currentStatus === status) {
                status = 'none';
            }
            
            cardStatuses[cardId] = status;
            
            const cardElement = document.querySelector(`[data-id="${cardId}"]`);
            cardElement.className = `card-item ${status}`;
            cardElement.setAttribute('data-status', status);
            
            // Update button states
            const buttons = cardElement.querySelectorAll('.status-btn');
            buttons.forEach(btn => {
                btn.className = 'status-btn none';
            });
            
            if (status !== 'none') {
                const activeButton = cardElement.querySelector(`[onclick*="'${status}'"]`);
                if (activeButton) {
                    activeButton.className = `status-btn ${status}`;
                }
            }
            
            updateStats();
            await saveUserData();
        };

        function updateStats() {
            const owned = Object.values(cardStatuses).filter(s => s === 'owned').length;
            const wanted = Object.values(cardStatuses).filter(s => s === 'wanted').length;
            const total = cardData.length;
            const completion = Math.round((owned / total) * 100);
            
            document.getElementById('ownedCount').textContent = owned;
            document.getElementById('wantedCount').textContent = wanted;
            document.getElementById('completionRate').textContent = completion + '%';
        }

        window.filterCards = function(filter) {
            const cards = document.querySelectorAll('.card-item');
            const buttons = document.querySelectorAll('.filter-btn');
            
            // Update active button
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            cards.forEach(card => {
                const status = card.getAttribute('data-status');
                if (filter === 'all' || status === filter) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        };

        // Initialize when DOM loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, checking for public view...');
            // Auth state observer will handle initialization
        });
    </script>
</body>
</html>
